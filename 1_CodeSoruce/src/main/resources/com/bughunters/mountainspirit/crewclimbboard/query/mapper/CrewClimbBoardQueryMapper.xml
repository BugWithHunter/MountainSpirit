<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bughunters.mountainspirit.crewclimbboard.query.mapper.CrewClimbBoardQueryMapper">
    <resultMap id="crewClimbBoardResultMap" type="com.bughunters.mountainspirit.crewclimbboard.query.dto.CrewClimbBoardAndMountainDTO">
        <id property="id" column="id"/>
        <result property="crewClimbStartDate" column="crewClimbStartDate"/>
        <result property="crewClimbRecruitStartDate" column="crewClimbRecruitStartDate"/>
        <result property="crewClimbRecruitEndDate" column="crewClimbRecruitEndDate"/>
        <result property="crewClimbContent" column="crewClimbContent"/>
        <result property="crewClimbIsDeleted" column="crewClimbIsDeleted"/>
        <result property="crewClimbAmountOfPeople" column="crewClimbAmountOfPeople"/>
        <result property="crewClimbIsEnded" column="crewClimbIsEnded"/>
        <result property="crewId" column="crewId"/>
        <result property="crewMemberId" column="crewMemberId"/>
        <result property="amountOfPeople" column="amountOfPeople"/>
        <association property="mountain" javaType="com.bughunters.mountainspirit.crewclimbboard.query.dto.MountainDTO">
            <id property="frtrlId" column="frtrlId"/>
            <result property="frtrlNm" column="frtrlNm"/>
        </association>
    </resultMap>
    <resultMap id="findOneCrewClimbBoardByCrewClimbBoardIdResultMap" type="com.bughunters.mountainspirit.crewclimbboard.query.dto.CrewClimbBoardAndMountainAndCrewMemberDTO">
        <id property="id" column="id"/>
        <result property="crewClimbStartDate" column="crewClimbStartDate"/>
        <result property="crewClimbRecruitStartDate" column="crewClimbRecruitStartDate"/>
        <result property="crewClimbRecruitEndDate" column="crewClimbRecruitEndDate"/>
        <result property="crewClimbContent" column="crewClimbContent"/>
        <result property="crewClimbIsDeleted" column="crewClimbIsDeleted"/>
        <result property="crewClimbAmountOfPeople" column="crewClimbAmountOfPeople"/>
        <result property="crewClimbIsEnded" column="crewClimbIsEnded"/>
        <result property="crewId" column="crewId"/>
        <association property="mountain" javaType="com.bughunters.mountainspirit.crewclimbboard.query.dto.MountainDTO">
            <id property="frtrlId" column="frtrlId"/>
            <result property="frtrlNm" column="frtrlNm"/>
        </association>
        <collection property="member" ofType="com.bughunters.mountainspirit.crewclimbboard.query.dto.MemberDTO">
            <id property="id" column="cid"/>
            <result property="nickName" column="nickName"/>
        </collection>
    </resultMap>
    <resultMap id="MyCrewClimbBoardByCrewMemberIdResultMap" type="com.bughunters.mountainspirit.crewclimbboard.query.dto.MyCrewClimbBoardListDTO">
        <id property="id" column="id"/>
        <result property="crewClimbHistoryIsSucceed" column="crewClimbHistoryIsSucceed"/>
        <result property="crewClimbId" column="crewClimbId"/>
        <result property="crewMemberId" column="crewMemberId"/>
        <result property="frtrlId" column="frtrlId"/>
    </resultMap>
    <select id="findAllCrewClimbBoardByCrewId" parameterType="_long" resultMap="crewClimbBoardResultMap">
        SELECT
               a.id
             , a.crewClimbStartDate
             , a.crewClimbRecruitStartDate
             , a.crewClimbRecruitEndDate
             , a.crewClimbContent
             , a.crewClimbIsDeleted
             , a.crewClimbAmountOfPeople
             , a.crewClimbIsEnded
             , a.crewId
             , a.crewMemberId
             , (SELECT COUNT(*) FROM CrewClimbRecord WHERE crewClimbId = a.id) as amountOfPeople
             , b.frtrlId
             , b.frtrlNm
          FROM CrewClimbBoard a JOIN Mountain b ON a.frtrlId = b.frtrlId
         WHERE crewId = #{crewId}
           AND crewClimbIsDeleted = 'N'
           AND crewMemberId IS NOT NULL
    </select>
    <select id="findOneCrewClimbBoardByCrewClimbBoardId" parameterType="_long" resultMap="findOneCrewClimbBoardByCrewClimbBoardIdResultMap">
        SELECT
               a.id
             , a.crewClimbStartDate
             , a.crewClimbRecruitStartDate
             , a.crewClimbRecruitEndDate
             , a.crewClimbContent
             , a.crewClimbIsDeleted
             , a.crewClimbAmountOfPeople
             , a.crewClimbIsEnded
             , a.crewId
             , b.frtrlId
             , b.frtrlNm
             , e.id as cid
             , e.nickName
        FROM CrewClimbBoard a JOIN Mountain b ON a.frtrlId = b.frtrlId
                              JOIN CrewClimbRecord c ON a.id = c.crewClimbId
                              JOIN CrewMember d ON c.crewMemberId = d.id
                              JOIN Member e ON d.cumId = e.id
        WHERE a.id = #{crewClimbBoardId}
          AND a.crewClimbIsDeleted = 'N'
          AND a.crewMemberId IS NOT NULL
    </select>
    <select id="findMyCrewClimbBoardByCrewMemberId" parameterType="_long" resultMap="MyCrewClimbBoardByCrewMemberIdResultMap">
        SELECT
               a.id
             , a.crewClimbHistoryIsSucceed
             , a.crewClimbId
             , a.crewMemberId
             , a.frtrlId
          FROM CrewClimbRecord a
         WHERE a.crewMemberId = #{crewMemberId}
    </select>

</mapper>